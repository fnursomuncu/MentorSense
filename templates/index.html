<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentorSense - Duygusal destek ve rehberlik saÄŸlayan sanal Ã¶ÄŸrenme arkadaÅŸÄ±.">
    <meta name="keywords" content="MentorSense, sanal asistan, duygusal destek, rehberlik, Gemini AI, Google AI">
    <meta name="author" content="Fatma Nur Somuncu">
    <title>MentorSense</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        :root {
            --primary-color: #6a67d9;
            --primary-dark: #5552b5;
            --text-color: #333;
            --bg-light: #f0f2f5;
            --msg-user-bg: #e2eafc;
            --msg-bot-bg: #f0f0f0;
            --badge-gold: #ffd700;
            /* Duyguya Ã¶zel arka plan renkleri */
            --bg-neutral: #f0f2f5;
            --bg-anxiety: #e6f2ff;
            --bg-stress: #e0f7fa;
            --bg-demotivation: #fff3e0;
            --bg-success: #e8f5e9;
            --bg-external-pressure: #e0e0e0;
            --bg-sadness: #ffe0e6;
            --bg-anger: #ffebed;
            --bg-frustration: #e0f7fa;
            --bg-loneliness: #e3f2fd;
            --bg-self-sacrifice: #f5f0e6;
            --bg-perfectionism: #e0f2f7;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-neutral);
            transition: background-color 0.5s ease;
            color: var(--text-color);
        }

        .chat-container {
            width: 100%;
            max-width: 500px;
            height: 90vh;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            /* Modal iÃ§in */
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            /* Ä°Ã§erikleri ayÄ±rmak iÃ§in */
            align-items: center;
            padding: 18px 20px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1.3em;
            font-weight: 600;
        }

        .header-title {
            display: flex;
            align-items: center;
        }

        .chat-header img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: #fff;
            padding: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .avatar-emoji {
            margin-left: 8px;
            font-size: 1.6em;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.95em;
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--msg-user-bg);
            border-bottom-right-radius: 6px;
        }

        .message.bot {
            align-self: flex-start;
            background-color: var(--msg-bot-bg);
            border-bottom-left-radius: 6px;
        }

        .chat-input {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            margin-right: 10px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(106, 103, 217, 0.2);
        }

        .chat-input button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .chat-input button:hover {
            background-color: var(--primary-dark);
        }

        .chat-input button:active {
            transform: translateY(1px);
        }

        .typing-indicator {
            font-style: italic;
            opacity: 0.7;
            align-self: flex-start;
            color: #555;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.7;
            }
        }

        /* --- ROZET STÄ°LLERÄ° --- */
        .badge-display {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .badge-display:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .badge-icon {
            font-size: 1.4em;
            /* ğŸ†Â  */
            margin-right: 8px;
        }

        .badge-count {
            font-size: 0.9em;
            font-weight: 700;
        }

        .badge-modal {
            display: none;
            /* BaÅŸlangÄ±Ã§ta gizli */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .badge-modal.show {
            display: flex;
            /* GÃ¶stermek iÃ§in */
        }

        .badge-modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .badge-modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.8;
            transition: opacity 0.3s, transform 0.3s;
        }

        .badge-item.locked {
            filter: grayscale(1);
            opacity: 0.5;
        }

        .badge-item.icon {
            font-size: 3em;
            line-height: 1;
        }

        .badge-item.name {
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.9em;
        }

        .badge-item.description {
            font-size: 0.8em;
            color: #666;
        }

        #closeBadgeModal {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
        }

        .message.badge-unlocked {
            align-self: center;
            background: linear-gradient(45deg, var(--primary-color), #8a88e4);
            color: white;
            text-align: center;
            font-weight: 600;
            max-width: 90%;
            box-shadow: 0 4px 10px rgba(106, 103, 217, 0.4);
        }

        .modal {
            display: none;
            position: absolute;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px 30px 30px 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 480px;
            /* Max-width gÃ¼ncellendi */
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .info-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            margin-left: 35px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            /* Daire ÅŸeklinde */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .info-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .info-btn.material-symbols-outlined {
            font-size: 20px;
            /* Ä°kon boyutu */
        }

        /* --- KULLANICI ADI MODAL STÄ°LLERÄ° --- */
        .user-name-modal {
            display: none;
            /* JS ile 'flex' yapÄ±lacak */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 101;
            /* Rozet modalÄ±ndan daha yÃ¼ksek */
        }

        .user-name-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            width: 80%;
            max-width: 350px;
        }

        .user-name-modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .user-name-modal-content input {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .user-name-modal-content button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .user-name-modal-content button:hover {
            background-color: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="header-title">
                <img src="/static/Avatar.png" alt="MentorSense Avatar" id="mentorSenseAvatar">
                <span>MentorSense <span class="avatar-emoji" id="currentEmoji"> ğŸ˜Š </span></span>
                <button class="info-btn" id="openInfo" title="KÃ¼Ã§Ã¼k bir not">
                    <span class="material-symbols-outlined">info</span>
                </button>
            </div>
            <div class="badge-display" id="badgeDisplay">
                <span class="badge-icon"> ğŸ† </span>
                <span class="badge-count" id="badgeCount">0 / 11</span>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">Merhaba! DuygularÄ±nÄ± ve dÃ¼ÅŸÃ¼ncelerini benimle paylaÅŸmaya hazÄ±r mÄ±sÄ±n?</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="DÃ¼ÅŸÃ¼ncelerini buraya yaz...">
            <button id="sendBtn">GÃ¶nder</button>
        </div>
    </div>
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h2> ğŸŸ£ MentorSense UygulamasÄ± HakkÄ±nda</h2>
            <p>MentorSense, duygusal zeka ve empati becerilerini geliÅŸtirmeye yÃ¶nelik yapay zeka tabanlÄ± bir uygulamadÄ±r.
                KullanÄ±cÄ±larÄ±n duygularÄ±nÄ± anlamalarÄ±na ve ifade etmelerine yardÄ±mcÄ± olur.</p>
            <p>Uygulama, kullanÄ±cÄ±larÄ±n duygusal durumlarÄ±nÄ± analiz ederek, onlara uygun geri bildirimler ve Ã¶neriler sunar.
                Bu sayede, kullanÄ±cÄ±lar duygusal zekalarÄ±nÄ± geliÅŸtirme fÄ±rsatÄ± bulurlar.</p>
            <br>
            <h3><small>GerÃ§ek bir insandan kÃ¼Ã§Ã¼k bir not ğŸ˜Š </small></h3>
            <p><small>Sevgili kullanÄ±cÄ±, her baÅŸarÄ±sÄ±zlÄ±k birer hediyedir. Onlara sahip Ã§Ä±kmalÄ± ve ilerlemeye devam
                    etmelisin.</small></p>
        </div>
    </div>
    <div class="badge-modal" id="badgeModal">
        <div class="badge-modal-content">
            <h2>KazanÄ±lan Rozetler</h2>
            <div class="badge-grid" id="badgeGrid">
            </div>
            <button id="closeBadgeModal">Kapat</button>
        </div>
    </div>
    <div class="user-name-modal" id="userNameModal">
        <div class="user-name-modal-content">
            <h2>HoÅŸ Geldin!</h2>
            <p>Sana nasÄ±l hitap etmeliyim?</p>
            <input type="text" id="userNameInput" placeholder="AdÄ±n...">
            <button id="saveUserNameBtn">Kaydet</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chatMessages');
            const currentEmoji = document.getElementById('currentEmoji');
            const openInfoBtn = document.getElementById('openInfo');
            const infoModal = document.getElementById('infoModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const API_ENDPOINT = 'http://127.0.0.1:5000/generate'; // Kendi sunucumuzun endpoint'i

            // --- KULLANICI ADI MODAL DEÄÄ°ÅKENLERÄ° ---
            const userNameModal = document.getElementById('userNameModal');
            const userNameInput = document.getElementById('userNameInput');
            const saveUserNameBtn = document.getElementById('saveUserNameBtn');
            // --- KULLANICI ADI MODAL DEÄÄ°ÅKENLERÄ° SONU ---

            // --- ROZET SÄ°STEMÄ° BAÅLANGIÃ‡ ---
            const badgeDisplay = document.getElementById('badgeDisplay');
            const badgeModal = document.getElementById('badgeModal');
            const badgeGrid = document.getElementById('badgeGrid');
            const closeBadgeModalBtn = document.getElementById('closeBadgeModal');
            const badgeCountEl = document.getElementById('badgeCount');
            // TÃ¼m rozetlerin tanÄ±mÄ±
            const badges = {
                firstStep: {
                    name: "Ä°lk AdÄ±m",
                    description: "Ä°lk mesajÄ±nÄ± gÃ¶nderdin.",
                    icon: " ğŸ‘‹ "
                },
                explorer: {
                    name: "KaÅŸif",
                    description: "3 farklÄ± duygunu paylaÅŸtÄ±n.",
                    icon: " ğŸ§­ "
                },
                frequentUser: {
                    name: "MÃ¼davim",
                    description: "10'dan fazla mesaj gÃ¶nderdin.",
                    icon: " ğŸ’¬ "
                },
                overcomer: {
                    name: "Zoru BaÅŸaran",
                    description: "Stresli bir durumdan sonra baÅŸarÄ± paylaÅŸtÄ±n.",
                    icon: " ğŸ’ª "
                },
                positiveVibes: {
                    name: "Pozitif Enerji",
                    description: "Ä°lk baÅŸarÄ± veya mutluluÄŸunu paylaÅŸtÄ±n.",
                    icon: " ğŸ‰ "
                },
                braveHeart: {
                    name: "Cesur YÃ¼rek",
                    description: "Zor bir duyguyu (Ã¶fke, Ã¼zÃ¼ntÃ¼, kaygÄ±) paylaÅŸtÄ±n.",
                    icon: " â¤ï¸ â€ ğŸ©¹ "
                },
                philosopher: {
                    name: "DÃ¼ÅŸÃ¼nÃ¼r",
                    description: "Derin bir konuyu (mÃ¼kemmeliyetÃ§ilik, fedakarlÄ±k) aÃ§tÄ±n.",
                    icon: " ğŸ¤” "
                },
                selfAware: {
                    name: "FarkÄ±ndalÄ±k",
                    description: "Duygu analizi Ã¶zelliÄŸini 5 kez kullandÄ±n.",
                    icon: " ğŸ§˜ "
                },
                resilience: {
                    name: "DirenÃ§li Ruh",
                    description: "3 olumsuz duygu bildiriminden sonra pozitif bir duygu paylaÅŸtÄ±n.",
                    icon: " ğŸŒ± "
                },
                consistentCommunicator: {
                    name: "DÃ¼zenli Ä°letiÅŸimci",
                    description: "3 farklÄ± gÃ¼nde mesaj gÃ¶nderdin.",
                    icon: " ğŸ—“ï¸ "
                },
                goalSetter: {
                    name: "Hedef Belirleyici",
                    description: "KaygÄ± veya motivasyon eksikliÄŸi sonrasÄ± Ã§Ã¶zÃ¼m odaklÄ± bir konuÅŸma yaptÄ±n.",
                    icon: " ğŸ¯ "
                }
            };
            const totalBadgeCount = Object.keys(badges).length;
            let appState = {
                messageCount: 0,
                unlockedBadges: new Set(),
                sentimentHistory: [], // Son 10 duygu tutulur
                userName: null,
                messageDates: new Set(), // Mesaj gÃ¶nderilen farklÄ± gÃ¼nlerin takibi (YYYY-MM-DD formatÄ±nda)
                previousUserMessageWasProblematic: false // Hedef belirleyici rozeti iÃ§in
            };
            // Durumu LocalStorage'a kaydetme
            function saveState() {
                const stateToSave = {
                    ...appState,
                    unlockedBadges: Array.from(appState.unlockedBadges),
                    // Set'i array'e Ã§evir
                    messageDates: Array.from(appState.messageDates) // Set'i array'e Ã§evir
                };
                localStorage.setItem('mentorSenseState', JSON.stringify(stateToSave));
            }
            // Durumu LocalStorage'dan yÃ¼kleme
            function loadState() {
                const savedState = localStorage.getItem('mentorSenseState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    appState = {
                        ...parsedState,
                        unlockedBadges: new Set(parsedState.unlockedBadges),
                        // Array'i Set'e Ã§evir
                        messageDates: new Set(parsedState.messageDates) // Array'i Set'e Ã§evir
                    };
                }
                // EÄŸer kullanÄ±cÄ± adÄ± yoksa modalÄ± gÃ¶ster
                if (!appState.userName) {
                    userNameModal.style.display = 'flex';
                } else {
                    // Ä°lk karÅŸÄ±lama mesajÄ±nÄ± kullanÄ±cÄ± adÄ±yla gÃ¼ncelle
                    const initialBotMessage = document.querySelector('.chat-messages .message.bot');
                    if (initialBotMessage) { // Ä°lk mesaj zaten eklenmiÅŸse gÃ¼ncelle
                        initialBotMessage.textContent = `Merhaba ${appState.userName}! DuygularÄ±nÄ± ve dÃ¼ÅŸÃ¼ncelerini benimle paylaÅŸmaya hazÄ±r mÄ±sÄ±n?`;
                    }
                }
            }
            openInfoBtn.addEventListener('click', () => infoModal.classList.add('show'));
            closeModalBtn.addEventListener('click', () => infoModal.classList.remove('show'));
            infoModal.addEventListener('click', (e) => {
                if (e.target === infoModal) { // Sadece modalÄ±n dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
                    infoModal.classList.remove('show');
                }
            });
            // KullanÄ±cÄ± adÄ±nÄ± kaydetme
            saveUserNameBtn.addEventListener('click', () => {
                const name = userNameInput.value.trim();
                if (name) {
                    appState.userName = name;
                    saveState();
                    userNameModal.style.display = 'none';
                    // Ä°lk karÅŸÄ±lama mesajÄ±nÄ± gÃ¼ncelle
                    const initialBotMessage = document.querySelector('.chat-messages .message.bot');
                    if (initialBotMessage) {
                        initialBotMessage.textContent = `Merhaba ${appState.userName}! DuygularÄ±nÄ± ve dÃ¼ÅŸÃ¼ncelerini benimle paylaÅŸmaya hazÄ±r mÄ±sÄ±n?`;
                    } else {
                        addMessage(`Merhaba ${appState.userName}! DuygularÄ±nÄ± ve dÃ¼ÅŸÃ¼ncelerini benimle paylaÅŸmaya hazÄ±r mÄ±sÄ±n?`, 'bot');
                    }
                } else {
                    alert("LÃ¼tfen adÄ±nÄ±zÄ± girin.");
                }
            });
            // Rozet kazanÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak fonksiyon
            function awardBadge(badgeId) {
                if (!appState.unlockedBadges.has(badgeId)) {
                    appState.unlockedBadges.add(badgeId);
                    const badge = badges[badgeId];

                    // Sohbete rozet kazanma mesajÄ± ekle
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', 'badge-unlocked');
                    messageDiv.innerHTML = ` âœ¨Â  Rozet KazandÄ±n: <strong>${badge.name}</strong> ${badge.icon}Â  âœ¨ `;
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    updateBadgeDisplay();
                    saveState();
                }
            }
            // Her mesaj sonrasÄ± rozet koÅŸullarÄ±nÄ± kontrol et
            function checkAndAwardBadges(detectedSentiment, userMessage) {
                const {
                    messageCount,
                    unlockedBadges,
                    sentimentHistory,
                    messageDates
                } = appState;

                // GÃ¼nlÃ¼k mesaj takibi iÃ§in mevcut gÃ¼nÃ¼ ekle
                const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
                appState.messageDates.add(today);
                // Ä°lk AdÄ±m
                if (messageCount >= 1) awardBadge('firstStep');
                // MÃ¼davim
                if (messageCount >= 10) awardBadge('frequentUser');
                // FarkÄ±ndalÄ±k
                if (sentimentHistory.length >= 5) awardBadge('selfAware');
                // KaÅŸif
                const uniqueSentiments = new Set(sentimentHistory.slice(-10).filter(s => s !== 'neutral'));
                if (uniqueSentiments.size >= 3) awardBadge('explorer');

                // Pozitif Enerji
                if (detectedSentiment === 'success') awardBadge('positiveVibes');
                // Cesur YÃ¼rek
                if (['sadness', 'anger', 'anxiety', 'frustration', 'loneliness'].includes(detectedSentiment)) awardBadge('braveHeart');
                // DÃ¼ÅŸÃ¼nÃ¼r
                if (['perfectionism', 'self-sacrifice'].includes(detectedSentiment)) awardBadge('philosopher');
                // Zoru BaÅŸaran
                const lastTwoSentiments = sentimentHistory.slice(-2);
                if (lastTwoSentiments.length === 2 &&
                    ['stress', 'anxiety', 'demotivation', 'frustration', 'external-pressure'].includes(lastTwoSentiments[0]) &&
                    lastTwoSentiments[1] === 'success') {
                    awardBadge('overcomer');
                }
                // DirenÃ§li Ruh
                const negativeSentiments = ['anxiety', 'stress', 'demotivation', 'sadness', 'anger', 'frustration', 'loneliness', 'external-pressure'];
                const positiveSentiments = ['success'];

                if (sentimentHistory.length >= 4) {
                    const recentSentiments = sentimentHistory.slice(-4);
                    const negativeCount = recentSentiments.slice(0, 3).filter(s => negativeSentiments.includes(s)).length;
                    const lastIsPositive = positiveSentiments.includes(recentSentiments[3]);
                    if (negativeCount >= 3 && lastIsPositive) {
                        awardBadge('resilience');
                    }
                }
                // DÃ¼zenli Ä°letiÅŸimci
                if (appState.messageDates.size >= 3) {
                    awardBadge('consistentCommunicator');
                }
                // Hedef Belirleyici
                if (appState.previousUserMessageWasProblematic) {
                    const userMessageLower = userMessage.toLowerCase();
                    const solutionKeywords = ['ne yapmalÄ±yÄ±m', 'Ã§Ã¶zÃ¼m arÄ±yorum', 'planÄ±m var', 'nasÄ±l baÅŸa Ã§Ä±kabilirim', 'deneyeceÄŸim', 'adÄ±m atacaÄŸÄ±m', 'yardÄ±m istiyorum'];
                    if (solutionKeywords.some(keyword => userMessageLower.includes(keyword))) {
                        awardBadge('goalSetter');
                        appState.previousUserMessageWasProblematic = false; // Rozeti verdikten sonra sÄ±fÄ±rla
                    }
                }
                // Bir sonraki mesaj iÃ§in problematic duygu durumunu ayarla
                if (negativeSentiments.includes(detectedSentiment)) {
                    appState.previousUserMessageWasProblematic = true;
                } else {
                    appState.previousUserMessageWasProblematic = false;
                }
                saveState();
            }
            // Rozet ekranÄ±nÄ± ve sayacÄ± gÃ¼ncelle
            function updateBadgeDisplay() {
                badgeGrid.innerHTML = '';
                const unlockedCount = appState.unlockedBadges.size;
                badgeCountEl.textContent = `${unlockedCount} / ${totalBadgeCount}`;
                for (const id in badges) {
                    const badge = badges[id];
                    const isUnlocked = appState.unlockedBadges.has(id);

                    const badgeEl = document.createElement('div');
                    badgeEl.classList.add('badge-item');
                    if (!isUnlocked) {
                        badgeEl.classList.add('locked');
                    }
                    badgeEl.innerHTML = `
<div class="icon">${badge.icon}</div>
<div class="name">${badge.name}</div>
<div class="description">${badge.description}</div>
`;
                    badgeGrid.appendChild(badgeEl);
                }
            }
            // Modal'Ä± aÃ§/kapat
            badgeDisplay.addEventListener('click', () => badgeModal.classList.add('show'));
            closeBadgeModalBtn.addEventListener('click', () => badgeModal.classList.remove('show'));
            badgeModal.addEventListener('click', (e) => {
                if (e.target === badgeModal) {
                    badgeModal.classList.remove('show');
                }
            });
            // --- ROZET SÄ°STEMÄ° SONU ---
            const sentimentMap = {
                'anxiety': {
                    bgColor: 'var(--bg-anxiety)',
                    emoji: ' ğŸ˜Ÿ '
                },
                'stress': {
                    bgColor: 'var(--bg-stress)',
                    emoji: ' ğŸ˜© '
                },
                'demotivation': {
                    bgColor: 'var(--bg-demotivation)',
                    emoji: ' ğŸ˜” '
                },
                'external-pressure': {
                    bgColor: 'var(--bg-external-pressure)',
                    emoji: ' ğŸ˜¬ '
                },
                'success': {
                    bgColor: 'var(--bg-success)',
                    emoji: ' ğŸ¥³ '
                },
                'neutral': {
                    bgColor: 'var(--bg-neutral)',
                    emoji: ' ğŸ™‚ '
                },
                'sadness': {
                    bgColor: 'var(--bg-sadness)',
                    emoji: ' ğŸ˜¢ '
                },
                'anger': {
                    bgColor: 'var(--bg-anger)',
                    emoji: ' ğŸ˜  '
                },
                'frustration': {
                    bgColor: 'var(--bg-frustration)',
                    emoji: ' ğŸ˜¤ '
                },
                'loneliness': {
                    bgColor: 'var(--bg-loneliness)',
                    emoji: ' ğŸ¥º '
                },
                'self-sacrifice': {
                    bgColor: 'var(--bg-self-sacrifice)',
                    emoji: ' ğŸ«  '
                },
                'perfectionism': {
                    bgColor: 'var(--bg-perfectionism)',
                    emoji: ' ğŸ§ '
                }
            };
            let typingIndicator = null;

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function showTypingIndicator() {
                typingIndicator = document.createElement('div');
                typingIndicator.classList.add('message', 'bot', 'typing-indicator');
                typingIndicator.textContent = 'MentorSense yazÄ±yor...';
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideTypingIndicator() {
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
            }

            function updateUIBySentiment(sentimentLabel) {
                const sentimentData = sentimentMap[sentimentLabel] || sentimentMap['neutral'];
                document.body.style.backgroundColor = sentimentData.bgColor;
                currentEmoji.textContent = sentimentData.emoji;
            }

            async function getGeminiResponse(message) {
                const userName = appState.userName ? appState.userName : "Ã¶ÄŸrenci";

                const fullPrompt = `Sen lise Ã¶ÄŸrencilerine duygusal destek ve rehberlik saÄŸlayan, bilgili ve empatik bir sanal Ã¶ÄŸrenme arkadaÅŸÄ±sÄ±n.
                    ${userName} adlÄ± kullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ± bu metni dikkatlice analiz et. Ä°Ã§indeki ana duyguyu (STRES, KAYGI, MOTIVASYON_EKSIKLIGI, DIS_BASKI, MUTLULUK/BASARI, UZUNTU, OFKE, HAYAL_KIRIKLIGI, YALNIZLIK, FEDAKARLIK, MUKEMMELIYETCILIK veya NOTR) tespit et.
                    Tespit ettiÄŸin duygu etiketini PARANTEZ Ä°Ã‡Ä°NDE ve BÃœYÃœK HARFLERLE, Ã¶rneÄŸin (STRES) veya (MUTLULUK/BASARI) ÅŸeklinde yanÄ±tÄ±nÄ±n BAÅINA ekle.
                    ArdÄ±ndan, bu duyguya Ã¶zel, nazik, cesaret verici ve yapÄ±cÄ± bir yanÄ±t oluÅŸtur. YanÄ±tÄ±n yaklaÅŸÄ±k 2-4 cÃ¼mle uzunluÄŸunda olsun.
                    MÃ¼mkÃ¼nse ${userName}'e doÄŸrudan hitap et. Ã–ÄŸrencinin mesajÄ±: "${message}"`;

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: fullPrompt
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error Response:', errorData);
                        throw new Error(`API isteÄŸi baÅŸarÄ±sÄ±z oldu: ${response.status} ${response.statusText}.`);
                    }

                    const data = await response.json();
                    return data.response;

                } catch (error) {
                    console.error('API Ã§aÄŸrÄ±sÄ±nda hata oluÅŸtu:', error);
                    return "(NOTR) ÃœzgÃ¼nÃ¼m, ÅŸu an sana yardÄ±mcÄ± olamÄ±yorum. Bir sorun oluÅŸtu.";
                }
            }

            sendBtn.addEventListener('click', async () => {
                const message = userInput.value.trim();
                if (message === '') return;
                addMessage(message, 'user');
                userInput.value = '';
                sendBtn.disabled = true;
                userInput.disabled = true;
                appState.messageCount++;
                showTypingIndicator();
                const botResponse = await getGeminiResponse(message);
                hideTypingIndicator();
                const sentimentMatch = botResponse.match(/\(([A-ZÃ‡ÄÄ°Ã–ÅÃœ\/_]+)\)/);
                let detectedSentimentFromGemini = 'neutral';
                let actualBotMessage = botResponse;
                if (sentimentMatch && sentimentMatch[1]) {
                    const rawSentiment = sentimentMatch[1].toLowerCase();

                    if (rawSentiment.includes('stres')) detectedSentimentFromGemini = 'stress';
                    else if (rawSentiment.includes('kaygi')) detectedSentimentFromGemini = 'anxiety';
                    else if (rawSentiment.includes('motivasyon_eksikligi')) detectedSentimentFromGemini = 'demotivation';
                    else if (rawSentiment.includes('dis_baski')) detectedSentimentFromGemini = 'external-pressure';
                    else if (rawSentiment.includes('mutluluk') || rawSentiment.includes('basari')) detectedSentimentFromGemini = 'success';
                    else if (rawSentiment.includes('uzuntu')) detectedSentimentFromGemini = 'sadness';
                    else if (rawSentiment.includes('ofke')) detectedSentimentFromGemini = 'anger';
                    else if (rawSentiment.includes('hayal_kirikligi')) detectedSentimentFromGemini = 'frustration';
                    else if (rawSentiment.includes('yalnizlik')) detectedSentimentFromGemini = 'loneliness';
                    else if (rawSentiment.includes('fedakarlik')) detectedSentimentFromGemini = 'self-sacrifice';
                    else if (rawSentiment.includes('mukemmeliyetcilik')) detectedSentimentFromGemini = 'perfectionism';
                    else detectedSentimentFromGemini = 'neutral';

                    actualBotMessage = botResponse.replace(sentimentMatch[0], '').trim();
                }
                // Son 10 duyguyu sakla
                appState.sentimentHistory.push(detectedSentimentFromGemini);
                if (appState.sentimentHistory.length > 10) {
                    appState.sentimentHistory.shift(); // En eskiyi sil
                }
                checkAndAwardBadges(detectedSentimentFromGemini, message);
                updateUIBySentiment(detectedSentimentFromGemini);
                addMessage(actualBotMessage, 'bot');
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            });
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendBtn.click();
                }
            });
            // Sayfa yÃ¼klendiÄŸinde durumu yÃ¼kle ve UI'yÄ± gÃ¼ncelle
            loadState();
            updateUIBySentiment('neutral');
            updateBadgeDisplay();
        });
    </script>
</body>
</html>