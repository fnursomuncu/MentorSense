<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentorSense - Duygusal destek ve rehberlik saƒülayan sanal √∂ƒürenme arkada≈üƒ±.">
    <meta name="keywords" content="MentorSense, sanal asistan, duygusal destek, rehberlik, Gemini AI, Google AI">
    <meta name="author" content="Fatma Nur Somuncu">
    <title>MentorSense</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        :root {
            --primary-color: #6a67d9;
            --primary-dark: #5552b5;
            --text-color: #333;
            --bg-light: #f0f2f5;
            --msg-user-bg: #e2eafc;
            --msg-bot-bg: #f0f0f0;
            --badge-gold: #ffd700;
            /* Duyguya √∂zel arka plan renkleri */
            --bg-neutral: #f0f2f5;
            --bg-anxiety: #e6f2ff;
            --bg-stress: #e0f7fa;
            --bg-demotivation: #fff3e0;
            --bg-success: #e8f5e9;
            --bg-external-pressure: #e0e0e0;
            --bg-sadness: #ffe0e6;
            --bg-anger: #ffebed;
            --bg-frustration: #e0f7fa;
            --bg-loneliness: #e3f2fd;
            --bg-self-sacrifice: #f5f0e6;
            --bg-perfectionism: #e0f2f7;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-neutral);
            transition: background-color 0.5s ease;
            color: var(--text-color);
        }

        .chat-container {
            width: 100%;
            max-width: 500px;
            height: 90vh;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            /* Modal i√ßin */
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            /* ƒ∞√ßerikleri ayƒ±rmak i√ßin */
            align-items: center;
            padding: 18px 20px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1.3em;
            font-weight: 600;
        }

        .header-title {
            display: flex;
            align-items: center;
        }

        .chat-header img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: #fff;
            padding: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .avatar-emoji {
            margin-left: 8px;
            font-size: 1.6em;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.95em;
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--msg-user-bg);
            border-bottom-right-radius: 6px;
        }

        .message.bot {
            align-self: flex-start;
            background-color: var(--msg-bot-bg);
            border-bottom-left-radius: 6px;
        }

        .chat-input {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            margin-right: 10px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(106, 103, 217, 0.2);
        }

        .chat-input button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .chat-input button:hover {
            background-color: var(--primary-dark);
        }

        .chat-input button:active {
            transform: translateY(1px);
        }

        .typing-indicator {
            font-style: italic;
            opacity: 0.7;
            align-self: flex-start;
            color: #555;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.7;
            }
        }

        /* --- ROZET STƒ∞LLERƒ∞ --- */
        .badge-display {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .badge-display:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .badge-icon {
            font-size: 1.4em;
            /* üèÜ¬† */
            margin-right: 8px;
        }

        .badge-count {
            font-size: 0.9em;
            font-weight: 700;
        }

        .badge-modal {
            display: none;
            /* Ba≈ülangƒ±√ßta gizli */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .badge-modal.show {
            display: flex;
            /* G√∂stermek i√ßin */
        }

        .badge-modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .badge-modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.8;
            transition: opacity 0.3s, transform 0.3s;
        }

        .badge-item.locked {
            filter: grayscale(1);
            opacity: 0.5;
        }

        .badge-item.icon {
            font-size: 3em;
            line-height: 1;
        }

        .badge-item.name {
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.9em;
        }

        .badge-item.description {
            font-size: 0.8em;
            color: #666;
        }

        #closeBadgeModal {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
        }

        .message.badge-unlocked {
            align-self: center;
            background: linear-gradient(45deg, var(--primary-color), #8a88e4);
            color: white;
            text-align: center;
            font-weight: 600;
            max-width: 90%;
            box-shadow: 0 4px 10px rgba(106, 103, 217, 0.4);
        }

        .modal {
            display: none;
            position: absolute;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px 30px 30px 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 480px;
            /* Max-width g√ºncellendi */
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .info-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            margin-left: 35px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            /* Daire ≈üeklinde */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .info-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .info-btn.material-symbols-outlined {
            font-size: 20px;
            /* ƒ∞kon boyutu */
        }

        /* --- KULLANICI ADI MODAL STƒ∞LLERƒ∞ --- */
        .user-name-modal {
            display: none;
            /* JS ile 'flex' yapƒ±lacak */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 101;
            /* Rozet modalƒ±ndan daha y√ºksek */
        }

        .user-name-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            width: 80%;
            max-width: 350px;
        }

        .user-name-modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .user-name-modal-content input {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .user-name-modal-content button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .user-name-modal-content button:hover {
            background-color: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="header-title">
                <img src="/static/Avatar.png" alt="MentorSense Avatar" id="mentorSenseAvatar">
                <span>MentorSense <span class="avatar-emoji" id="currentEmoji"> üòä </span></span>
                <button class="info-btn" id="openInfo" title="K√º√ß√ºk bir not">
                    <span class="material-symbols-outlined">info</span>
                </button>
            </div>
            <div class="badge-display" id="badgeDisplay">
                <span class="badge-icon"> üèÜ </span>
                <span class="badge-count" id="badgeCount">0 / 11</span>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">Merhaba! Duygularƒ±nƒ± ve d√º≈ü√ºncelerini benimle payla≈ümaya hazƒ±r mƒ±sƒ±n?</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="D√º≈ü√ºncelerini buraya yaz...">
            <button id="sendBtn">G√∂nder</button>
        </div>
    </div>
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h2> üü£ MentorSense Uygulamasƒ± Hakkƒ±nda</h2>
            <p>MentorSense, duygusal zeka ve empati becerilerini geli≈ütirmeye y√∂nelik yapay zeka tabanlƒ± bir uygulamadƒ±r.
                Kullanƒ±cƒ±larƒ±n duygularƒ±nƒ± anlamalarƒ±na ve ifade etmelerine yardƒ±mcƒ± olur.</p>
            <p>Uygulama, kullanƒ±cƒ±larƒ±n duygusal durumlarƒ±nƒ± analiz ederek, onlara uygun geri bildirimler ve √∂neriler sunar.
                Bu sayede, kullanƒ±cƒ±lar duygusal zekalarƒ±nƒ± geli≈ütirme fƒ±rsatƒ± bulurlar.</p>
            <br>
            <h3><small>Ger√ßek bir insandan k√º√ß√ºk bir not üòä </small></h3>
            <p><small>Sevgili kullanƒ±cƒ±, her ba≈üarƒ±sƒ±zlƒ±k birer hediyedir. Onlara sahip √ßƒ±kmalƒ± ve ilerlemeye devam
                    etmelisin.</small></p>
        </div>
    </div>
    <div class="badge-modal" id="badgeModal">
        <div class="badge-modal-content">
            <h2>Kazanƒ±lan Rozetler</h2>
            <div class="badge-grid" id="badgeGrid">
            </div>
            <button id="closeBadgeModal">Kapat</button>
        </div>
    </div>
    <div class="user-name-modal" id="userNameModal">
        <div class="user-name-modal-content">
            <h2>Ho≈ü Geldin!</h2>
            <p>Sana nasƒ±l hitap etmeliyim?</p>
            <input type="text" id="userNameInput" placeholder="Adƒ±n...">
            <button id="saveUserNameBtn">Kaydet</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chatMessages');
            const currentEmoji = document.getElementById('currentEmoji');
            const openInfoBtn = document.getElementById('openInfo');
            const infoModal = document.getElementById('infoModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const API_ENDPOINT = 'http://127.0.0.1:5000/generate'; // Kendi sunucumuzun endpoint'i

            // --- KULLANICI ADI MODAL DEƒûƒ∞≈ûKENLERƒ∞ ---
            const userNameModal = document.getElementById('userNameModal');
            const userNameInput = document.getElementById('userNameInput');
            const saveUserNameBtn = document.getElementById('saveUserNameBtn');
            // --- KULLANICI ADI MODAL DEƒûƒ∞≈ûKENLERƒ∞ SONU ---

            // --- ROZET Sƒ∞STEMƒ∞ BA≈ûLANGI√á ---
            const badgeDisplay = document.getElementById('badgeDisplay');
            const badgeModal = document.getElementById('badgeModal');
            const badgeGrid = document.getElementById('badgeGrid');
            const closeBadgeModalBtn = document.getElementById('closeBadgeModal');
            const badgeCountEl = document.getElementById('badgeCount');
            // T√ºm rozetlerin tanƒ±mƒ±
            const badges = {
                firstStep: {
                    name: "ƒ∞lk Adƒ±m",
                    description: "ƒ∞lk mesajƒ±nƒ± g√∂nderdin.",
                    icon: " üëã "
                },
                explorer: {
                    name: "Ka≈üif",
                    description: "3 farklƒ± duygunu payla≈ütƒ±n.",
                    icon: " üß≠ "
                },
                frequentUser: {
                    name: "M√ºdavim",
                    description: "10'dan fazla mesaj g√∂nderdin.",
                    icon: " üí¨ "
                },
                overcomer: {
                    name: "Zoru Ba≈üaran",
                    description: "Stresli bir durumdan sonra ba≈üarƒ± payla≈ütƒ±n.",
                    icon: " üí™ "
                },
                positiveVibes: {
                    name: "Pozitif Enerji",
                    description: "ƒ∞lk ba≈üarƒ± veya mutluluƒüunu payla≈ütƒ±n.",
                    icon: " üéâ "
                },
                braveHeart: {
                    name: "Cesur Y√ºrek",
                    description: "Zor bir duyguyu (√∂fke, √ºz√ºnt√º, kaygƒ±) payla≈ütƒ±n.",
                    icon: " ‚ù§Ô∏è ‚Äç ü©π "
                },
                philosopher: {
                    name: "D√º≈ü√ºn√ºr",
                    description: "Derin bir konuyu (m√ºkemmeliyet√ßilik, fedakarlƒ±k) a√ßtƒ±n.",
                    icon: " ü§î "
                },
                selfAware: {
                    name: "Farkƒ±ndalƒ±k",
                    description: "Duygu analizi √∂zelliƒüini 5 kez kullandƒ±n.",
                    icon: " üßò "
                },
                resilience: {
                    name: "Diren√ßli Ruh",
                    description: "3 olumsuz duygu bildiriminden sonra pozitif bir duygu payla≈ütƒ±n.",
                    icon: " üå± "
                },
                consistentCommunicator: {
                    name: "D√ºzenli ƒ∞leti≈üimci",
                    description: "3 farklƒ± g√ºnde mesaj g√∂nderdin.",
                    icon: " üóìÔ∏è "
                },
                goalSetter: {
                    name: "Hedef Belirleyici",
                    description: "Kaygƒ± veya motivasyon eksikliƒüi sonrasƒ± √ß√∂z√ºm odaklƒ± bir konu≈üma yaptƒ±n.",
                    icon: " üéØ "
                }
            };
            const totalBadgeCount = Object.keys(badges).length;
            let appState = {
                messageCount: 0,
                unlockedBadges: new Set(),
                sentimentHistory: [], // Son 10 duygu tutulur
                userName: null,
                messageDates: new Set(), // Mesaj g√∂nderilen farklƒ± g√ºnlerin takibi (YYYY-MM-DD formatƒ±nda)
                previousUserMessageWasProblematic: false // Hedef belirleyici rozeti i√ßin
            };
            // Durumu LocalStorage'a kaydetme
            function saveState() {
                const stateToSave = {
                    ...appState,
                    unlockedBadges: Array.from(appState.unlockedBadges),
                    // Set'i array'e √ßevir
                    messageDates: Array.from(appState.messageDates) // Set'i array'e √ßevir
                };
                localStorage.setItem('mentorSenseState', JSON.stringify(stateToSave));
            }
            // Durumu LocalStorage'dan y√ºkleme
            function loadState() {
                const savedState = localStorage.getItem('mentorSenseState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    appState = {
                        ...parsedState,
                        unlockedBadges: new Set(parsedState.unlockedBadges),
                        // Array'i Set'e √ßevir
                        messageDates: new Set(parsedState.messageDates) // Array'i Set'e √ßevir
                    };
                }
                // Eƒüer kullanƒ±cƒ± adƒ± yoksa modalƒ± g√∂ster
                if (!appState.userName) {
                    userNameModal.style.display = 'flex';
                } else {
                    // ƒ∞lk kar≈üƒ±lama mesajƒ±nƒ± kullanƒ±cƒ± adƒ±yla g√ºncelle
                    const initialBotMessage = document.querySelector('.chat-messages .message.bot');
                    if (initialBotMessage) { // ƒ∞lk mesaj zaten eklenmi≈üse g√ºncelle
                        initialBotMessage.textContent = `Merhaba ${appState.userName}! Duygularƒ±nƒ± ve d√º≈ü√ºncelerini benimle payla≈ümaya hazƒ±r mƒ±sƒ±n?`;
                    }
                }
            }
            openInfoBtn.addEventListener('click', () => infoModal.classList.add('show'));
            closeModalBtn.addEventListener('click', () => infoModal.classList.remove('show'));
            infoModal.addEventListener('click', (e) => {
                if (e.target === infoModal) { // Sadece modalƒ±n dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
                    infoModal.classList.remove('show');
                }
            });
            // Kullanƒ±cƒ± adƒ±nƒ± kaydetme
            saveUserNameBtn.addEventListener('click', () => {
                const name = userNameInput.value.trim();
                if (name) {
                    appState.userName = name;
                    saveState();
                    userNameModal.style.display = 'none';
                    // ƒ∞lk kar≈üƒ±lama mesajƒ±nƒ± g√ºncelle
                    const initialBotMessage = document.querySelector('.chat-messages .message.bot');
                    if (initialBotMessage) {
                        initialBotMessage.textContent = `Merhaba ${appState.userName}! Duygularƒ±nƒ± ve d√º≈ü√ºncelerini benimle payla≈ümaya hazƒ±r mƒ±sƒ±n?`;
                    } else {
                        addMessage(`Merhaba ${appState.userName}! Duygularƒ±nƒ± ve d√º≈ü√ºncelerini benimle payla≈ümaya hazƒ±r mƒ±sƒ±n?`, 'bot');
                    }
                } else {
                    alert("L√ºtfen adƒ±nƒ±zƒ± girin.");
                }
            });
            // Rozet kazanƒ±ldƒ±ƒüƒ±nda √ßalƒ±≈üacak fonksiyon
            function awardBadge(badgeId) {
                if (!appState.unlockedBadges.has(badgeId)) {
                    appState.unlockedBadges.add(badgeId);
                    const badge = badges[badgeId];

                    // Sohbete rozet kazanma mesajƒ± ekle
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', 'badge-unlocked');
                    messageDiv.innerHTML = ` ‚ú®¬† Rozet Kazandƒ±n: <strong>${badge.name}</strong> ${badge.icon}¬† ‚ú® `;
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    updateBadgeDisplay();
                    saveState();
                }
            }
            // Her mesaj sonrasƒ± rozet ko≈üullarƒ±nƒ± kontrol et
            function checkAndAwardBadges(detectedSentiment, userMessage) {
                const {
                    messageCount,
                    unlockedBadges,
                    sentimentHistory,
                    messageDates
                } = appState;

                // G√ºnl√ºk mesaj takibi i√ßin mevcut g√ºn√º ekle
                const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
                appState.messageDates.add(today);
                // ƒ∞lk Adƒ±m
                if (messageCount >= 1) awardBadge('firstStep');
                // M√ºdavim
                if (messageCount >= 10) awardBadge('frequentUser');
                // Farkƒ±ndalƒ±k
                if (sentimentHistory.length >= 5) awardBadge('selfAware');
                // Ka≈üif
                const uniqueSentiments = new Set(sentimentHistory.slice(-10).filter(s => s !== 'neutral'));
                if (uniqueSentiments.size >= 3) awardBadge('explorer');

                // Pozitif Enerji
                if (detectedSentiment === 'success') awardBadge('positiveVibes');
                // Cesur Y√ºrek
                if (['sadness', 'anger', 'anxiety', 'frustration', 'loneliness'].includes(detectedSentiment)) awardBadge('braveHeart');
                // D√º≈ü√ºn√ºr
                if (['perfectionism', 'self-sacrifice'].includes(detectedSentiment)) awardBadge('philosopher');
                // Zoru Ba≈üaran
                const lastTwoSentiments = sentimentHistory.slice(-2);
                if (lastTwoSentiments.length === 2 &&
                    ['stress', 'anxiety', 'demotivation', 'frustration', 'external-pressure'].includes(lastTwoSentiments[0]) &&
                    lastTwoSentiments[1] === 'success') {
                    awardBadge('overcomer');
                }
                // Diren√ßli Ruh
                const negativeSentiments = ['anxiety', 'stress', 'demotivation', 'sadness', 'anger', 'frustration', 'loneliness', 'external-pressure'];
                const positiveSentiments = ['success'];

                if (sentimentHistory.length >= 4) {
                    const recentSentiments = sentimentHistory.slice(-4);
                    const negativeCount = recentSentiments.slice(0, 3).filter(s => negativeSentiments.includes(s)).length;
                    const lastIsPositive = positiveSentiments.includes(recentSentiments[3]);
                    if (negativeCount >= 3 && lastIsPositive) {
                        awardBadge('resilience');
                    }
                }
                // D√ºzenli ƒ∞leti≈üimci
                if (appState.messageDates.size >= 3) {
                    awardBadge('consistentCommunicator');
                }
                // Hedef Belirleyici
                if (appState.previousUserMessageWasProblematic) {
                    const userMessageLower = userMessage.toLowerCase();
                    const solutionKeywords = ['ne yapmalƒ±yƒ±m', '√ß√∂z√ºm arƒ±yorum', 'planƒ±m var', 'nasƒ±l ba≈üa √ßƒ±kabilirim', 'deneyeceƒüim', 'adƒ±m atacaƒüƒ±m', 'yardƒ±m istiyorum'];
                    if (solutionKeywords.some(keyword => userMessageLower.includes(keyword))) {
                        awardBadge('goalSetter');
                        appState.previousUserMessageWasProblematic = false; // Rozeti verdikten sonra sƒ±fƒ±rla
                    }
                }
                // Bir sonraki mesaj i√ßin problematic duygu durumunu ayarla
                if (negativeSentiments.includes(detectedSentiment)) {
                    appState.previousUserMessageWasProblematic = true;
                } else {
                    appState.previousUserMessageWasProblematic = false;
                }
                saveState();
            }
            // Rozet ekranƒ±nƒ± ve sayacƒ± g√ºncelle
            function updateBadgeDisplay() {
                badgeGrid.innerHTML = '';
                const unlockedCount = appState.unlockedBadges.size;
                badgeCountEl.textContent = `${unlockedCount} / ${totalBadgeCount}`;
                for (const id in badges) {
                    const badge = badges[id];
                    const isUnlocked = appState.unlockedBadges.has(id);

                    const badgeEl = document.createElement('div');
                    badgeEl.classList.add('badge-item');
                    if (!isUnlocked) {
                        badgeEl.classList.add('locked');
                    }
                    badgeEl.innerHTML = `
<div class="icon">${badge.icon}</div>
<div class="name">${badge.name}</div>
<div class="description">${badge.description}</div>
`;
                    badgeGrid.appendChild(badgeEl);
                }
            }
            // Modal'ƒ± a√ß/kapat
            badgeDisplay.addEventListener('click', () => badgeModal.classList.add('show'));
            closeBadgeModalBtn.addEventListener('click', () => badgeModal.classList.remove('show'));
            badgeModal.addEventListener('click', (e) => {
                if (e.target === badgeModal) {
                    badgeModal.classList.remove('show');
                }
            });
            // --- ROZET Sƒ∞STEMƒ∞ SONU ---
            const sentimentMap = {
                'anxiety': {
                    bgColor: 'var(--bg-anxiety)',
                    emoji: ' üòü '
                },
                'stress': {
                    bgColor: 'var(--bg-stress)',
                    emoji: ' üò© '
                },
                'demotivation': {
                    bgColor: 'var(--bg-demotivation)',
                    emoji: ' üòî '
                },
                'external-pressure': {
                    bgColor: 'var(--bg-external-pressure)',
                    emoji: ' üò¨ '
                },
                'success': {
                    bgColor: 'var(--bg-success)',
                    emoji: ' ü•≥ '
                },
                'neutral': {
                    bgColor: 'var(--bg-neutral)',
                    emoji: ' üôÇ '
                },
                'sadness': {
                    bgColor: 'var(--bg-sadness)',
                    emoji: ' üò¢ '
                },
                'anger': {
                    bgColor: 'var(--bg-anger)',
                    emoji: ' üò† '
                },
                'frustration': {
                    bgColor: 'var(--bg-frustration)',
                    emoji: ' üò§ '
                },
                'loneliness': {
                    bgColor: 'var(--bg-loneliness)',
                    emoji: ' ü•∫ '
                },
                'self-sacrifice': {
                    bgColor: 'var(--bg-self-sacrifice)',
                    emoji: ' ü´† '
                },
                'perfectionism': {
                    bgColor: 'var(--bg-perfectionism)',
                    emoji: ' üßê '
                }
            };
            let typingIndicator = null;

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function showTypingIndicator() {
                typingIndicator = document.createElement('div');
                typingIndicator.classList.add('message', 'bot', 'typing-indicator');
                typingIndicator.textContent = 'MentorSense yazƒ±yor...';
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideTypingIndicator() {
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
            }

            function updateUIBySentiment(sentimentLabel) {
                const sentimentData = sentimentMap[sentimentLabel] || sentimentMap['neutral'];
                document.body.style.backgroundColor = sentimentData.bgColor;
                currentEmoji.textContent = sentimentData.emoji;
            }

            async function getGeminiResponse(message) {
                const userName = appState.userName ? appState.userName : "√∂ƒürenci";

                const fullPrompt = `Sen lise √∂ƒürencilerine duygusal destek ve rehberlik saƒülayan, bilgili ve empatik bir sanal √∂ƒürenme arkada≈üƒ±sƒ±n.
                    ${userName} adlƒ± kullanƒ±cƒ±nƒ±n yazdƒ±ƒüƒ± bu metni dikkatlice analiz et. ƒ∞√ßindeki ana duyguyu (STRES, KAYGI, MOTIVASYON_EKSIKLIGI, DIS_BASKI, MUTLULUK/BASARI, UZUNTU, OFKE, HAYAL_KIRIKLIGI, YALNIZLIK, FEDAKARLIK, MUKEMMELIYETCILIK veya NOTR) tespit et.
                    Tespit ettiƒüin duygu etiketini PARANTEZ ƒ∞√áƒ∞NDE ve B√úY√úK HARFLERLE, √∂rneƒüin (STRES) veya (MUTLULUK/BASARI) ≈üeklinde yanƒ±tƒ±nƒ±n BA≈ûINA ekle.
                    Ardƒ±ndan, bu duyguya √∂zel, nazik, cesaret verici ve yapƒ±cƒ± bir yanƒ±t olu≈ütur. Yanƒ±tƒ±n yakla≈üƒ±k 2-4 c√ºmle uzunluƒüunda olsun.
                    M√ºmk√ºnse ${userName}'e doƒürudan hitap et. √ñƒürencinin mesajƒ±: "${message}"`;

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: fullPrompt
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error Response:', errorData);
                        throw new Error(`API isteƒüi ba≈üarƒ±sƒ±z oldu: ${response.status} ${response.statusText}.`);
                    }

                    const data = await response.json();
                    return data.response;

                } catch (error) {
                    console.error('API √ßaƒürƒ±sƒ±nda hata olu≈ütu:', error);
                    return "(NOTR) √úzg√ºn√ºm, ≈üu an sana yardƒ±mcƒ± olamƒ±yorum. Bir sorun olu≈ütu.";
                }
            }

            sendBtn.addEventListener('click', async () => {
                const message = userInput.value.trim();
                if (message === '') return;
                addMessage(message, 'user');
                userInput.value = '';
                sendBtn.disabled = true;
                userInput.disabled = true;
                appState.messageCount++;
                showTypingIndicator();
                const botResponse = await getGeminiResponse(message);
                hideTypingIndicator();
                const sentimentMatch = botResponse.match(/\(([A-Z√áƒûƒ∞√ñ≈û√ú\/_]+)\)/);
                let detectedSentimentFromGemini = 'neutral';
                let actualBotMessage = botResponse;
                if (sentimentMatch && sentimentMatch[1]) {
                    const rawSentiment = sentimentMatch[1].toLowerCase();

                    if (rawSentiment.includes('stres')) detectedSentimentFromGemini = 'stress';
                    else if (rawSentiment.includes('kaygi')) detectedSentimentFromGemini = 'anxiety';
                    else if (rawSentiment.includes('motivasyon_eksikligi')) detectedSentimentFromGemini = 'demotivation';
                    else if (rawSentiment.includes('dis_baski')) detectedSentimentFromGemini = 'external-pressure';
                    else if (rawSentiment.includes('mutluluk') || rawSentiment.includes('basari')) detectedSentimentFromGemini = 'success';
                    else if (rawSentiment.includes('uzuntu')) detectedSentimentFromGemini = 'sadness';
                    else if (rawSentiment.includes('ofke')) detectedSentimentFromGemini = 'anger';
                    else if (rawSentiment.includes('hayal_kirikligi')) detectedSentimentFromGemini = 'frustration';
                    else if (rawSentiment.includes('yalnizlik')) detectedSentimentFromGemini = 'loneliness';
                    else if (rawSentiment.includes('fedakarlik')) detectedSentimentFromGemini = 'self-sacrifice';
                    else if (rawSentiment.includes('mukemmeliyetcilik')) detectedSentimentFromGemini = 'perfectionism';
                    else detectedSentimentFromGemini = 'neutral';

                    actualBotMessage = botResponse.replace(sentimentMatch[0], '').trim();
                }
                // Son 10 duyguyu sakla
                appState.sentimentHistory.push(detectedSentimentFromGemini);
                if (appState.sentimentHistory.length > 10) {
                    appState.sentimentHistory.shift(); // En eskiyi sil
                }
                checkAndAwardBadges(detectedSentimentFromGemini, message);
                updateUIBySentiment(detectedSentimentFromGemini);
                addMessage(actualBotMessage, 'bot');
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            });
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendBtn.click();
                }
            });
            // Sayfa y√ºklendiƒüinde durumu y√ºkle ve UI'yƒ± g√ºncelle
            loadState();
            updateUIBySentiment('neutral');
            updateBadgeDisplay();
        });
    </script>
</body>
</html>